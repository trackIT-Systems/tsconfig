<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Locate Control CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
    <!-- Custom CSS -->
    <link href="{{ url_for('static', path='css/style.css') }}" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Locate Control JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="d-flex flex-column h-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">{{ title }}</a>
        </div>
    </nav>

    <main>
        <div class="container mt-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Schedule Configuration</h5>
                </div>
                <div class="card-body">
                    <div x-data="configManager()" x-init="loadConfig(); initMap()">
                        <!-- Alert for messages -->
                        <template x-if="message !== ''">
                            <div x-cloak
                                 x-transition
                                 x-init="if (message && !error) setTimeout(() => message = '', 10000)"
                                 :class="{'alert-success': !error, 'alert-danger': error}"
                                 class="alert d-flex justify-content-between align-items-center" 
                                 role="alert">
                                <span x-text="message"></span>
                                <button type="button" 
                                        class="btn-close" 
                                        x-on:click="message = ''; error = false"
                                        aria-label="Close">
                                </button>
                            </div>
                        </template>

                        <!-- Main Configuration Form -->
                        <form @submit.prevent="saveConfig">
                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-4">
                                    <!-- Location -->
                                    <div class="mb-3">
                                        <h6>Location</h6>
                                        <div class="form-text mb-2">
                                            This location is used to compute astral events such as sunrise, sunset, dawn, dusk, and golden/blue hours for scheduling.
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label">Latitude</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       x-model="config.lat" 
                                                       @input="updateMarkerFromInputs()"
                                                       step="0.00000001" 
                                                       max="90"
                                                       min="-90"
                                                       required>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label">Longitude</label>
                                                <input type="number" 
                                                       class="form-control" 
                                                       x-model="config.lon" 
                                                       @input="updateMarkerFromInputs()"
                                                       step="0.00000001" 
                                                       max="180"
                                                       min="-180"
                                                       required>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Force On -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="config.force_on" 
                                                   id="forceOn">
                                            <label class="form-check-label" for="forceOn">Force On</label>
                                        </div>
                                        <div class="form-text">
                                            When enabled, this disables all scheduling and makes the tracker stay on permanently.
                                        </div>
                                    </div>

                                    <!-- Button Delay -->
                                    <div class="mb-3">
                                        <label class="form-label">Button Delay (HH:MM)</label>
                                        <input type="text" 
                                               class="form-control" 
                                               x-model="config.button_delay" 
                                               pattern="[0-9]{2}:[0-9]{2}" 
                                               required>
                                        <div class="form-text">
                                            This is the duration the tracker will stay on after manually pressing the power button or reconnecting power.
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column (Map) -->
                                <div class="col-md-8">
                                    <div id="map" class="map-container"></div>
                                </div>
                            </div>

                            <!-- Schedule Entries -->
                            <div class="mt-4">
                                <h6>Schedule Entries</h6>
                                <div class="form-text mb-3">Define time spans during which the tracker will be on. You can create multiple entries, and overlapping entries are allowed - the tracker will stay on continuously if entries overlap.</div>
                                <template x-for="(entry, index) in config.schedule" :key="index">
                                    <div class="schedule-entry">
                                        <div class="row mb-2">
                                            <div class="col">
                                                <label class="form-label">Name</label>
                                                <input type="text" 
                                                       class="form-control" 
                                                       x-model="entry.name" 
                                                       required>
                                            </div>
                                            <div class="col-auto d-flex align-items-end">
                                                <button type="button" 
                                                        class="btn btn-danger" 
                                                        @click="removeSchedule(index)">
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label class="form-label">Start Time</label>
                                                <div class="time-input-group">
                                                    <select class="form-select" 
                                                            x-model="entry.startReference"
                                                            @change="updateTimeString(entry, 'start')">
                                                        <option value="time">Clock Time</option>
                                                        <option value="sunrise">Sunrise</option>
                                                        <option value="sunset">Sunset</option>
                                                        <option value="dawn">Dawn</option>
                                                        <option value="dusk">Dusk</option>
                                                        <option value="noon">Solar Noon</option>
                                                        <option value="midnight">Solar Midnight</option>
                                                        <option value="blue_hour_morning">Blue Hour (Morning)</option>
                                                        <option value="blue_hour_evening">Blue Hour (Evening)</option>
                                                        <option value="golden_hour_morning">Golden Hour (Morning)</option>
                                                        <option value="golden_hour_evening">Golden Hour (Evening)</option>
                                                    </select>
                                                    <select class="form-select" 
                                                            x-model="entry.startSign"
                                                            @change="updateTimeString(entry, 'start')"
                                                            :disabled="entry.startReference === 'time'"
                                                            :value="entry.startReference === 'time' ? '+' : entry.startSign">
                                                        <option value="+">+</option>
                                                        <option value="-">-</option>
                                                    </select>
                                                    <input type="time" 
                                                           class="form-control" 
                                                           x-model="entry.startOffset"
                                                           @change="updateTimeString(entry, 'start')">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Stop Time</label>
                                                <div class="time-input-group">
                                                    <select class="form-select" 
                                                            x-model="entry.stopReference"
                                                            @change="updateTimeString(entry, 'stop')">
                                                        <option value="time">Clock Time</option>
                                                        <option value="sunrise">Sunrise</option>
                                                        <option value="sunset">Sunset</option>
                                                        <option value="dawn">Dawn</option>
                                                        <option value="dusk">Dusk</option>
                                                        <option value="noon">Solar Noon</option>
                                                        <option value="midnight">Solar Midnight</option>
                                                        <option value="blue_hour_morning">Blue Hour (Morning)</option>
                                                        <option value="blue_hour_evening">Blue Hour (Evening)</option>
                                                        <option value="golden_hour_morning">Golden Hour (Morning)</option>
                                                        <option value="golden_hour_evening">Golden Hour (Evening)</option>
                                                    </select>
                                                    <select class="form-select" 
                                                            x-model="entry.stopSign"
                                                            @change="updateTimeString(entry, 'stop')"
                                                            :disabled="entry.stopReference === 'time'"
                                                            :value="entry.stopReference === 'time' ? '+' : entry.stopSign">
                                                        <option value="+">+</option>
                                                        <option value="-">-</option>
                                                    </select>
                                                    <input type="time" 
                                                           class="form-control" 
                                                           x-model="entry.stopOffset"
                                                           @change="updateTimeString(entry, 'stop')">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div class="mt-4 mb-3 d-flex flex-column flex-sm-row justify-content-between gap-2">
                                    <button type="button" 
                                            class="btn btn-secondary" 
                                            @click="addSchedule">
                                        Add Schedule Entry
                                    </button>
                                    <div class="d-flex gap-2">
                                        <button type="button" 
                                                class="btn btn-outline-secondary" 
                                                @click="refreshConfig()">
                                            Reset
                                        </button>
                                        <button type="submit" 
                                                class="btn btn-success">
                                            Save Configuration
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer mt-auto bg-light">
        <div class="container py-3">
            <div class="row align-items-center h-100">
                <div class="col-sm py-2">
                    <span>tsconfig {{ version }} © trackIT Systems</span>
                </div>
                <div class="col-sm py-2">
                </div>
                <div class="col-sm py-2">
                </div>
                <div class="col-sm py-2 text-end">
                    <a href="https://trackit.systems" target="_blank"><i class="fa fa-globe lead" title="Website"></i></a>
                    <a href="mailto:info@trackit.systems" alt="send mail"><i class="fa fa-envelope lead" title="E-Mail"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Alpine.js Component -->
    <script>
        function configManager() {
            return {
                config: {
                    lat: 0,
                    lon: 0,
                    force_on: false,
                    button_delay: "00:00",
                    schedule: []
                },
                message: '',
                error: false,
                map: null,
                marker: null,

                initMap() {
                    // Initialize map
                    this.map = L.map('map', {
                        center: [this.config.lat, this.config.lon],
                        zoom: 13,
                        zoomControl: true
                    });
                    
                    // Add Mapbox satellite streets layer
                    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoidHJhY2tpdHN5c3RlbXMiLCJhIjoiY21iaHEwbXcwMDEzcTJqc2JhNzdobDluaSJ9.NLRmiJEDHQgPJEyceCA57g', {
                        attribution: '© Mapbox © OpenStreetMap',
                        maxZoom: 19
                    }).addTo(this.map);

                    // Add locate control
                    L.control.locate({
                        position: 'topleft',
                        strings: {
                            title: "Show my location"
                        },
                        flyTo: true,
                        keepCurrentZoomLevel: true,
                        locateOptions: {
                            enableHighAccuracy: true
                        }
                    }).addTo(this.map);

                    // Add marker
                    this.marker = L.marker([this.config.lat, this.config.lon], {
                        draggable: true
                    }).addTo(this.map);

                    // Update coordinates when marker is dragged
                    this.marker.on('dragend', (e) => {
                        const position = e.target.getLatLng();
                        this.config.lat = position.lat.toFixed(8);
                        this.config.lon = position.lng.toFixed(8);
                    });

                    // Update marker when map is clicked
                    this.map.on('click', (e) => {
                        const position = e.latlng;
                        this.marker.setLatLng(position);
                        this.config.lat = position.lat.toFixed(8);
                        this.config.lon = position.lng.toFixed(8);
                    });

                    // Handle location found event
                    this.map.on('locationfound', (e) => {
                        this.config.lat = e.latlng.lat.toFixed(8);
                        this.config.lon = e.latlng.lng.toFixed(8);
                        this.updateMarkerFromInputs();
                    });
                },

                updateMarkerFromInputs() {
                    if (this.marker) {
                        // Ensure coordinates are within bounds and have proper precision
                        const lat = Math.min(Math.max(parseFloat(this.config.lat), -90), 90);
                        const lon = Math.min(Math.max(parseFloat(this.config.lon), -180), 180);
                        
                        // Update the marker and map view
                        this.marker.setLatLng([lat, lon]);
                        this.map.setView([lat, lon]);
                        
                        // Update the input values with properly formatted numbers
                        this.config.lat = lat.toFixed(8);
                        this.config.lon = lon.toFixed(8);
                    }
                },

                async refreshConfig() {
                    console.log('Reset button clicked');
                    try {
                        // Reset to initial state
                        this.config = {
                            lat: 0,
                            lon: 0,
                            force_on: false,
                            button_delay: "00:00",
                            schedule: []
                        };
                        
                        // Clear any existing messages
                        this.message = '';
                        this.error = false;
                        
                        console.log('About to load config');
                        // Reload the configuration
                        await this.loadConfig();
                        console.log('Config loaded');
                    } catch (error) {
                        console.error('Error in refreshConfig:', error);
                        this.showMessage(error.message, true);
                    }
                },

                async loadConfig() {
                    console.log('loadConfig called');
                    try {
                        // Clear any existing message before loading
                        this.message = '';
                        this.error = false;

                        console.log('Fetching config from server...');
                        const response = await fetch('/api/config', {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        console.log('Server response:', response.status);
                        if (!response.ok) throw new Error('Failed to load configuration');
                        const data = await response.json();
                        console.log('Received data:', data);
                        
                        // Process schedule entries to split time strings
                        data.schedule = data.schedule.map(entry => {
                            const start = this.parseTimeString(entry.start);
                            const stop = this.parseTimeString(entry.stop);
                            return {
                                ...entry,
                                startReference: start.reference,
                                startOffset: start.offset,
                                startSign: start.sign,
                                stopReference: stop.reference,
                                stopOffset: stop.offset,
                                stopSign: stop.sign
                            };
                        });
                        
                        // Update the config with new data
                        this.config = { ...data };  // Create a new object to ensure reactivity
                        
                        // Update map if it exists
                        if (this.map) {
                            this.updateMarkerFromInputs();
                        }
                    } catch (error) {
                        console.error('Error loading config:', error);
                        this.showMessage(error.message, true);
                    }
                },

                parseTimeString(timeStr) {
                    if (timeStr.includes('sunrise')) {
                        return {
                            reference: 'sunrise',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('sunrise', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('sunset')) {
                        return {
                            reference: 'sunset',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('sunset', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('dawn')) {
                        return {
                            reference: 'dawn',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('dawn', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('dusk')) {
                        return {
                            reference: 'dusk',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('dusk', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('noon')) {
                        return {
                            reference: 'noon',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('noon', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('midnight')) {
                        return {
                            reference: 'midnight',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('midnight', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('blue_hour_morning')) {
                        return {
                            reference: 'blue_hour_morning',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('blue_hour_morning', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('blue_hour_evening')) {
                        return {
                            reference: 'blue_hour_evening',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('blue_hour_evening', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('golden_hour_morning')) {
                        return {
                            reference: 'golden_hour_morning',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('golden_hour_morning', '').replace('+', '').replace('-', '').trim()
                        };
                    } else if (timeStr.includes('golden_hour_evening')) {
                        return {
                            reference: 'golden_hour_evening',
                            sign: timeStr.includes('-') ? '-' : '+',
                            offset: timeStr.replace('golden_hour_evening', '').replace('+', '').replace('-', '').trim()
                        };
                    } else {
                        return {
                            reference: 'time',
                            sign: '+',
                            offset: timeStr
                        };
                    }
                },

                updateTimeString(entry, type) {
                    const reference = entry[`${type}Reference`];
                    const sign = entry[`${type}Sign`];
                    const offset = entry[`${type}Offset`];
                    
                    if (reference === 'time') {
                        entry[type] = offset;
                    } else {
                        entry[type] = `${reference}${sign}${offset}`;
                    }
                },

                addSchedule() {
                    this.config.schedule.push({
                        name: '',
                        start: '00:00',
                        stop: '00:00',
                        startReference: 'time',
                        startOffset: '00:00',
                        startSign: '+',
                        stopReference: 'time',
                        stopOffset: '00:00',
                        stopSign: '+'
                    });
                },

                removeSchedule(index) {
                    this.config.schedule.splice(index, 1);
                },

                async saveConfig() {
                    try {
                        const response = await fetch('/api/config', {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.config)
                        });
                        if (!response.ok) throw new Error('Failed to save configuration');
                        const data = await response.json();
                        this.showMessage(data.message, !data.error);
                    } catch (error) {
                        this.showMessage(error.message, true);
                    }
                },

                showMessage(message, isSuccess) {
                    this.message = message;
                    this.error = !isSuccess;
                }
            }
        }
    </script>
</body>
</html>
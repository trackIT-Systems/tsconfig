<!-- System Settings (Schedule + SSH Keys) -->
<div x-show="activeConfig === 'settings'" x-cloak x-data="{ 
    systemTab: 'schedule',
    
    init() {
        // Parse subtab from URL hash (format: #settings/subtab)
        const parseSubtab = () => {
            const hash = window.location.hash.slice(1); // Remove #
            const parts = hash.split('/');
            if (parts[0] === 'settings' && parts.length > 1) {
                const subtab = parts[1];
                if (['schedule', 'sshkeys', 'configupload'].includes(subtab)) {
                    return subtab;
                }
            }
            return 'schedule'; // Default
        };
        
        this.systemTab = parseSubtab();
        
        // Watch for systemTab changes and update URL
        this.$watch('systemTab', (value) => {
            const currentHash = window.location.hash.slice(1);
            const parts = currentHash.split('/');
            if (parts[0] === 'settings') {
                window.location.hash = `settings/${value}`;
            }
        });
        
        // Listen for hash changes (back/forward browser navigation)
        window.addEventListener('hashchange', () => {
            const newSubtab = parseSubtab();
            if (newSubtab !== this.systemTab) {
                this.systemTab = newSubtab;
            }
        });
    }
}">
    <div class="row">
        <div class="col">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" 
                            :class="{ 'active': systemTab === 'schedule' }"
                            @click="systemTab = 'schedule'"
                            type="button">
                        <i class="fas fa-calendar-alt me-1"></i>
                        Schedule
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" 
                            :class="{ 'active': systemTab === 'sshkeys' }"
                            @click="systemTab = 'sshkeys'"
                            type="button">
                        <i class="fas fa-key me-1"></i>
                        SSH Keys
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" 
                            :class="{ 'active': systemTab === 'configupload' }"
                            @click="systemTab = 'configupload'"
                            type="button">
                        <i class="fas fa-file-archive me-1"></i>
                        Config Upload
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content">
                <!-- Schedule Tab -->
                <div x-show="systemTab === 'schedule'">
                    <div class="card" x-data="scheduleConfig()" x-init="init()" x-destroy="cleanup()">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <!-- Service status elements - hidden in server mode -->
                                <template x-if="!serverMode">
                                    <div class="d-flex align-items-center">
                                        <!-- Enable/Disable Toggle -->
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="enableSwitch-wittypid"
                                                   :checked="serviceStatus.enabled"
                                                   @change="toggleEnable('wittypid', serviceStatus.enabled)"
                                                   :disabled="actionLoading || serviceStatus.status === 'not-found'">
                                            <label class="form-check-label" for="enableSwitch-wittypid" style="display: none;">
                                            </label>
                                        </div>
                                        
                                        <h5 class="card-title mb-0 me-2">wittypid</h5>
                                        <!-- Service Status Indicator -->
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge d-flex align-items-center gap-1" 
                                                    :class="{
                                                        'bg-success': serviceStatus.active && serviceStatus.status === 'active',
                                                        'bg-danger': !serviceStatus.active && serviceStatus.status !== 'not-found' && serviceStatus.status !== 'timeout' && serviceStatus.status !== 'error' && serviceStatus.status !== 'unknown',
                                                        'bg-secondary': serviceStatus.status === 'not-found' || serviceStatus.status === 'unknown',
                                                        'bg-warning': serviceStatus.status === 'timeout' || serviceStatus.status === 'error'
                                                    }">
                                                <span class="d-none d-sm-inline" x-text="serviceStatus.active ? 'Active' : (serviceStatus.status === 'not-found' ? 'Not Found' : (serviceStatus.status === 'timeout' || serviceStatus.status === 'error' ? 'Error' : 'Inactive'))"></span>
                                                <span class="d-sm-none" x-text="serviceStatus.active ? 'ON' : 'OFF'"></span>
                                            </span>
                                            <small class="text-muted">
                                                <i class="fas fa-clock me-1"></i>
                                                <span x-text="serviceStatus.uptime"></span>
                                            </small>
                                        </div>
                                    </div>
                                </template>
                                <!-- Server mode: Simple title -->
                                <template x-if="serverMode">
                                    <h5 class="card-title mb-0">Schedule Configuration</h5>
                                </template>
                            </div>
                            <button type="button" 
                                    class="btn btn-outline-info btn-sm" 
                                    @click="streamLogs('wittypid')"
                                    title="View wittypid service logs"
                                    x-show="!serverMode">
                                <i class="fas fa-file-alt me-1"></i>
                                Logs
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Schedule Configuration Form -->
                            <form @submit.prevent="saveConfig">
                                <!-- General Section -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-cogs me-2"></i>
                                        General
                                    </h6>
                                    
                                    <div class="row">
                                        <!-- Configuration Column -->
                                        <div class="col-md-12">
                                            <!-- Force On -->
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    <input class="form-check-input" 
                                                            type="checkbox" 
                                                            x-model="config.force_on" 
                                                            id="forceOn">
                                                    <label class="form-check-label" for="forceOn">Force On</label>
                                                </div>
                                                <div class="form-text">
                                                    When enabled, this disables all scheduling and makes the tracker stay on permanently.
                                                </div>
                                            </div>

                                            <!-- Button Delay -->
                                            <div class="mb-3">
                                                <label class="form-label">Button Delay (HH:MM)</label>
                                                <input type="text" 
                                                        class="form-control" 
                                                        x-model="config.button_delay" 
                                                        pattern="[0-9]{2}:[0-9]{2}" 
                                                        required>
                                                <div class="form-text">
                                                    This is the duration the tracker will stay on after manually pressing the power button or reconnecting power.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Schedule Entries Section -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-calendar-alt me-2"></i>
                                        Schedule Entries
                                    </h6>
                                    <div class="form-text mb-3">Define time spans during which the tracker will be on. You can create multiple entries, and overlapping entries are allowed - the tracker will stay on continuously if entries overlap.</div>
                                    <template x-for="(entry, index) in config.schedule" :key="index">
                                        <div class="bg-light rounded-2 p-3 mb-2">
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <div class="d-flex align-items-center flex-grow-1 me-3">
                                                    <i class="fas fa-clock text-primary me-2"></i>
                                                    <input type="text" 
                                                            class="form-control form-control-sm fw-medium" 
                                                            x-model="entry.name" 
                                                            placeholder="Enter schedule name..." 
                                                            required>
                                                </div>
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm" 
                                                        @click="removeSchedule(index)"
                                                        title="Remove schedule">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <label class="text-success fw-semibold small mb-0 schedule-label">
                                                            <i class="fas fa-play me-1"></i><span class="d-none d-md-inline">Start</span>
                                                        </label>
                                                        <div class="row g-1 flex-grow-1">
                                                            <div class="col">
                                                                <select class="form-select form-select-sm" 
                                                                        x-model="entry.startReference"
                                                                        @change="updateTimeString(entry, 'start')">
                                                                    <option value="time">Clock Time</option>
                                                                    <option value="sunrise">Sunrise</option>
                                                                    <option value="sunset">Sunset</option>
                                                                    <option value="dawn">Dawn</option>
                                                                    <option value="dusk">Dusk</option>
                                                                    <option value="noon">Solar Noon</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <select class="form-select form-select-sm" 
                                                                        style="width: 70px;"
                                                                        x-model="entry.startSign"
                                                                        @change="updateTimeString(entry, 'start')"
                                                                        :disabled="entry.startReference === 'time'"
                                                                        :value="entry.startReference === 'time' ? '+' : entry.startSign">
                                                                    <option value="+">+</option>
                                                                    <option value="-">-</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <input type="time" 
                                                                        class="form-control form-control-sm" 
                                                                        style="width: 110px;"
                                                                        x-model="entry.startOffset"
                                                                        @change="updateTimeString(entry, 'start')">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <label class="text-danger fw-semibold small mb-0 schedule-label">
                                                            <i class="fas fa-stop me-1"></i><span class="d-none d-md-inline">Stop</span>
                                                        </label>
                                                        <div class="row g-1 flex-grow-1">
                                                            <div class="col">
                                                                <select class="form-select form-select-sm" 
                                                                        x-model="entry.stopReference"
                                                                        @change="updateTimeString(entry, 'stop')">
                                                                    <option value="time">Clock Time</option>
                                                                    <option value="sunrise">Sunrise</option>
                                                                    <option value="sunset">Sunset</option>
                                                                    <option value="dawn">Dawn</option>
                                                                    <option value="dusk">Dusk</option>
                                                                    <option value="noon">Solar Noon</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <select class="form-select form-select-sm" 
                                                                        style="width: 70px;"
                                                                        x-model="entry.stopSign"
                                                                        @change="updateTimeString(entry, 'stop')"
                                                                        :disabled="entry.stopReference === 'time'"
                                                                        :value="entry.stopReference === 'time' ? '+' : entry.stopSign">
                                                                    <option value="+">+</option>
                                                                    <option value="-">-</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <input type="time" 
                                                                        class="form-control form-control-sm" 
                                                                        style="width: 110px;"
                                                                        x-model="entry.stopOffset"
                                                                        @change="updateTimeString(entry, 'stop')">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div class="mt-3">
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                @click="addSchedule">
                                            <i class="fas fa-plus me-2"></i>
                                            Add Schedule Entry
                                        </button>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="d-flex justify-content-between gap-2">
                                    <div class="d-flex gap-2">
                                        <button type="button" 
                                                class="btn btn-outline-secondary" 
                                                @click="refreshConfig()">
                                            Reset
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="submit" 
                                                class="btn"
                                                :class="{
                                                    'btn-success': saveState === 'idle',
                                                    'btn-primary': saveState === 'saving',
                                                    'btn-outline-success': saveState === 'saved'
                                                }"
                                                :disabled="saveState === 'saving'">
                                            <template x-if="saveState === 'idle'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-save me-1"></i>
                                                    Save
                                                </div>
                                            </template>
                                            <template x-if="saveState === 'saving'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                    Saving...
                                                </div>
                                            </template>
                                            <template x-if="saveState === 'saved'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-check me-1"></i>
                                                    Saved!
                                                </div>
                                            </template>
                                        </button>
                                        <button type="button" 
                                                class="btn"
                                                :class="{
                                                    'btn-warning': saveRestartState === 'idle',
                                                    'btn-primary': saveRestartState === 'saving' || saveRestartState === 'restarting',
                                                    'btn-outline-success': saveRestartState === 'saved'
                                                }"
                                                @click="saveAndRestartService()"
                                                :disabled="saveRestartState === 'saving' || saveRestartState === 'restarting'"
                                                x-show="!serverMode">
                                            <template x-if="saveRestartState === 'idle'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-save me-1"></i>
                                                    <i class="fas fa-redo me-1"></i>
                                                    Save & Restart
                                                </div>
                                            </template>
                                            <template x-if="saveRestartState === 'saving'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                    Saving...
                                                </div>
                                            </template>
                                            <template x-if="saveRestartState === 'restarting'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                    Restarting...
                                                </div>
                                            </template>
                                            <template x-if="saveRestartState === 'saved'">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-check me-1"></i>
                                                    Saved & Restarted!
                                                </div>
                                            </template>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- SSH Keys Tab -->
                <div x-show="systemTab === 'sshkeys'">
                    <div class="card" x-data="sshKeysConfig()" x-init="init()">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-key me-2"></i>
                                SSH Authorized Keys
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Existing Keys List -->
                            <div class="mb-4">
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-list me-2"></i>
                                    Authorized Keys (<span x-text="keys.length"></span>)
                                </h6>
                                
                                <template x-if="keys.length === 0">
                                    <div class="text-muted text-center py-4">
                                        <i class="fas fa-key fa-3x mb-3 opacity-25"></i>
                                        <p>No SSH keys configured yet. Add one below to enable SSH access.</p>
                                    </div>
                                </template>

                                <template x-if="keys.length > 0">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th style="width: 100px;">Type</th>
                                                    <th>Key Preview / Comment</th>
                                                    <th style="width: 100px;" class="text-end">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(key, index) in keys" :key="index">
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-secondary" x-text="key.key_type"></span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-column">
                                                                <code class="small text-truncate" style="max-width: 500px;" x-text="key.key_data ? key.key_data.substring(0, 40) + '...' : ''"></code>
                                                                <small class="text-muted" x-show="key.comment" x-text="key.comment"></small>
                                                            </div>
                                                        </td>
                                                        <td class="text-end">
                                                            <button type="button" 
                                                                    class="btn btn-outline-danger btn-sm" 
                                                                    @click="removeKey(index)"
                                                                    title="Remove this key">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>
                            </div>

                            <!-- Add New Key Form -->
                            <div>
                                <h6 class="border-bottom pb-2">
                                    <i class="fas fa-plus me-2"></i>
                                    Add New SSH Key
                                </h6>
                                <form @submit.prevent="addKey">
                                    <div class="mb-2">
                                        <label class="form-label">SSH Public Key</label>
                                        <textarea class="form-control font-monospace small" 
                                                  x-model="newKey"
                                                  rows="4" 
                                                  placeholder="Paste your SSH public key here (e.g., ssh-rsa AAAAB3NzaC1yc2EA... user@hostname)"
                                                  required></textarea>
                                        <div class="form-text">
                                            Paste the entire contents of your SSH public key file.
                                        </div>
                                    </div>
                                    <div class="text-end mt-1">
                                        <button type="submit" 
                                                class="btn btn-success"
                                                :disabled="!newKey.trim() || loading">
                                            <template x-if="!loading">
                                                <span>
                                                    <i class="fas fa-plus me-1"></i>
                                                    Add Key
                                                </span>
                                            </template>
                                            <template x-if="loading">
                                                <span>
                                                    <i class="fas fa-spinner fa-spin me-1"></i>
                                                    Saving...
                                                </span>
                                            </template>
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Toast notifications appear in top-right corner -->
                        </div>
                    </div>
                </div>

                <!-- Config Upload Tab -->
                <div x-show="systemTab === 'configupload'">
                    <div class="card" x-data="configUpload()" x-init="init()">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-file-archive me-2"></i>
                                Configuration Upload
                            </h5>
                        </div>
                        <div class="card-body">
                            <form @submit.prevent="uploadConfig" enctype="multipart/form-data">
                                <!-- File Selection -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-file me-2"></i>
                                        Select Configuration ZIP
                                    </h6>
                                    <div class="mb-3">
                                        <label class="form-label">Configuration ZIP File</label>
                                        <input type="file" 
                                               class="form-control" 
                                               @change="handleFileChange"
                                               accept=".zip"
                                               :disabled="uploading"
                                               required>
                                        <div class="form-text">
                                            Upload a ZIP file containing configuration files. All files will be validated before applying any changes. 
                                            Supported: <code>radiotracking.ini</code>, <code>schedule.yml</code>, <code>soundscapepipe.yml</code>, 
                                            <code>authorized_keys</code>, <code>cmdline.txt</code>, <code>wireguard.conf</code>, <code>server.crt</code>, 
                                            <code>server.conf</code>, <code>geolocation</code>.
                                        </div>
                                        <template x-if="selectedFile">
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-file-archive me-1"></i>
                                                    Selected: <span x-text="selectedFile.name"></span>
                                                    (<span x-text="formatFileSize(selectedFile.size)"></span>)
                                                </small>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Upload Options -->
                                <div class="mb-4">
                                    <h6 class="border-bottom pb-2">
                                        <i class="fas fa-cog me-2"></i>
                                        Upload Options
                                    </h6>
                                    
                                    <!-- Force Overwrite -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="options.force" 
                                                   id="forceOverwrite"
                                                   :disabled="uploading">
                                            <label class="form-check-label" for="forceOverwrite">
                                                <strong>Force Overwrite</strong>
                                            </label>
                                        </div>
                                        <div class="form-text ms-4">
                                            When enabled, all files will be overwritten regardless of modification timestamps. 
                                            When disabled, only newer files will be applied.
                                        </div>
                                    </div>

                                    <!-- Pedantic Mode -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="options.pedantic" 
                                                   id="pedanticMode"
                                                   :disabled="uploading || options.force">
                                            <label class="form-check-label" for="pedanticMode">
                                                <strong>Pedantic Mode</strong>
                                            </label>
                                        </div>
                                        <div class="form-text ms-4">
                                            Reject upload if any existing file is newer than the ZIP version, or if unknown files are present.
                                            This option is ignored when Force Overwrite is enabled.
                                        </div>
                                    </div>

                                    <!-- Restart Services -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="options.restartServices" 
                                                   id="restartServices"
                                                   :disabled="uploading || options.reboot">
                                            <label class="form-check-label" for="restartServices">
                                                <strong>Restart Services</strong>
                                            </label>
                                        </div>
                                        <div class="form-text ms-4">
                                            Automatically restart affected services after successfully applying the configuration. 
                                            This option is ignored if System Reboot is enabled.
                                        </div>
                                    </div>

                                    <!-- System Reboot -->
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="options.reboot" 
                                                   id="systemReboot"
                                                   :disabled="uploading">
                                            <label class="form-check-label" for="systemReboot">
                                                <strong>System Reboot</strong>
                                                <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                            </label>
                                        </div>
                                        <div class="form-text ms-4">
                                            Automatically reboot the system after successfully applying the configuration. 
                                            This will restart all services and temporarily interrupt connectivity.
                                        </div>
                                    </div>
                                </div>

                                <!-- Upload Button -->
                                <div class="d-grid gap-2">
                                    <button type="submit" 
                                            class="btn btn-lg"
                                            :class="{
                                                'btn-primary': !uploading && !uploadSuccess,
                                                'btn-success': uploadSuccess,
                                                'btn-secondary': uploading
                                            }"
                                            :disabled="uploading || !selectedFile">
                                        <template x-if="!uploading && !uploadSuccess">
                                            <span>
                                                <i class="fas fa-upload me-2"></i>
                                                Upload Configuration
                                            </span>
                                        </template>
                                        <template x-if="uploading">
                                            <span>
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Uploading...
                                            </span>
                                        </template>
                                        <template x-if="uploadSuccess">
                                            <span>
                                                <i class="fas fa-check me-2"></i>
                                                Upload Successful!
                                            </span>
                                        </template>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


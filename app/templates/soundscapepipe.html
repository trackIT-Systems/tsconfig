<!-- Soundscapepipe Configuration -->
<style>
    /* Custom styling for form-range inputs in species groups */
    .bg-light .form-range::-webkit-slider-track {
        background: #ffffff !important;
    }
    .bg-light .form-range::-moz-range-track {
        background: #ffffff !important;
    }
    .bg-light .form-range::-ms-track {
        background: #ffffff !important;
    }
    .bg-light .form-range::-webkit-slider-runnable-track {
        background: #ffffff !important;
    }
    .bg-light .form-range::-moz-range-progress {
        background: #ffffff !important;
    }
</style>
<div x-show="activeConfig === 'soundscapepipe'" x-cloak>
    <div class="row">
        <div class="col-12">
            <div class="card" x-data="soundscapepipeConfig()" x-init="init()" x-destroy="cleanup()">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <!-- Service status elements - hidden in server mode -->
                        <template x-if="!serverMode">
                            <div class="d-flex align-items-center">
                                <h5 class="card-title mb-0 me-2">soundscapepipe</h5>
                                <!-- Service Status Indicator -->
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge d-flex align-items-center gap-1" 
                                            :class="{
                                                'bg-success': serviceStatus.active && serviceStatus.status === 'active',
                                                'bg-danger': !serviceStatus.active && serviceStatus.status !== 'not-found' && serviceStatus.status !== 'timeout' && serviceStatus.status !== 'error' && serviceStatus.status !== 'unknown',
                                                'bg-secondary': serviceStatus.status === 'not-found' || serviceStatus.status === 'unknown',
                                                'bg-warning': serviceStatus.status === 'timeout' || serviceStatus.status === 'error'
                                            }">
                                        <span class="d-none d-sm-inline" x-text="serviceStatus.active ? 'Active' : (serviceStatus.status === 'not-found' ? 'Not Found' : (serviceStatus.status === 'timeout' || serviceStatus.status === 'error' ? 'Error' : 'Inactive'))"></span>
                                        <span class="d-sm-none" x-text="serviceStatus.active ? 'ON' : 'OFF'"></span>
                                    </span>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        <span x-text="serviceStatus.uptime"></span>
                                    </small>
                                </div>
                            </div>
                        </template>
                        <!-- Server mode: Simple title -->
                        <template x-if="serverMode">
                            <h5 class="card-title mb-0">Soundscapepipe Configuration</h5>
                        </template>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <!-- Start/Stop button -->
                        <button type="button" 
                                class="btn btn-sm" 
                                :class="{
                                    'btn-outline-success': (!serviceStatus.active && getServiceStartStopState('soundscapepipe') === 'idle') || getServiceStartStopState('soundscapepipe') === 'started',
                                    'btn-success': getServiceStartStopState('soundscapepipe') === 'starting',
                                    'btn-outline-danger': (serviceStatus.active && getServiceStartStopState('soundscapepipe') === 'idle') || getServiceStartStopState('soundscapepipe') === 'stopped',
                                    'btn-danger': getServiceStartStopState('soundscapepipe') === 'stopping'
                                }"
                                @click="performStartStopAction('soundscapepipe', serviceStatus.active ? 'stop' : 'start')"
                                :disabled="actionLoading || serviceStatus.status === 'not-found' || getServiceStartStopState('soundscapepipe') === 'starting' || getServiceStartStopState('soundscapepipe') === 'stopping'"
                                :title="serviceStatus.active ? 'Stop service' : 'Start service'"
                                x-show="!serverMode">
                            <template x-if="!serviceStatus.active && getServiceStartStopState('soundscapepipe') === 'idle'">
                                <i class="fas fa-play"></i>
                            </template>
                            <template x-if="serviceStatus.active && getServiceStartStopState('soundscapepipe') === 'idle'">
                                <i class="fas fa-stop"></i>
                            </template>
                            <template x-if="getServiceStartStopState('soundscapepipe') === 'starting'">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                            <template x-if="getServiceStartStopState('soundscapepipe') === 'stopping'">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                            <template x-if="getServiceStartStopState('soundscapepipe') === 'started'">
                                <i class="fas fa-check"></i>
                            </template>
                            <template x-if="getServiceStartStopState('soundscapepipe') === 'stopped'">
                                <i class="fas fa-check"></i>
                            </template>
                        </button>
                        <!-- Restart button -->
                        <button type="button" 
                                class="btn btn-sm" 
                                :class="{
                                    'btn-outline-warning': getServiceRestartState('soundscapepipe') === 'idle',
                                    'btn-primary': getServiceRestartState('soundscapepipe') === 'restarting',
                                    'btn-outline-success': getServiceRestartState('soundscapepipe') === 'restarted'
                                }"
                                @click="performAction('soundscapepipe', 'restart')"
                                :disabled="actionLoading || serviceStatus.status === 'not-found' || getServiceRestartState('soundscapepipe') === 'restarting'"
                                title="Restart service"
                                x-show="!serverMode">
                            <template x-if="getServiceRestartState('soundscapepipe') === 'idle'">
                                <i class="fas fa-redo"></i>
                            </template>
                            <template x-if="getServiceRestartState('soundscapepipe') === 'restarting'">
                                <i class="fas fa-spinner fa-spin"></i>
                            </template>
                            <template x-if="getServiceRestartState('soundscapepipe') === 'restarted'">
                                <i class="fas fa-check"></i>
                            </template>
                        </button>
                        <button type="button" 
                                class="btn btn-outline-info btn-sm" 
                                @click="streamLogs('soundscapepipe')"
                                :disabled="serviceStatus.status === 'not-found'"
                                title="View soundscapepipe service logs"
                                x-show="!serverMode">
                            <i class="fas fa-file-alt me-1"></i>
                            <span class="d-none d-md-inline">Logs</span>
                            <span class="d-md-none">Logs</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div x-show="!configLoaded" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">Loading configuration...</div>
                    </div>

                    <!-- Configuration Form -->
                    <form x-show="configLoaded" @submit.prevent="saveConfig">
                        <!-- Input Device Settings -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-microphone me-2"></i>
                                Input Device Settings
                            </h6>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <label class="form-label mb-0">Input Device</label>
                                                <small class="text-muted" x-show="serviceStatus.active">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Stop soundscapepipe service to refresh audio device lists
                                                </small>
                                            </div>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="loadAudioDevices()"
                                                    :disabled="loadingDevices || serviceStatus.active"
                                                    title="Refresh audio devices">
                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingDevices }"></i>
                                            </button>
                                        </div>
                                        <template x-if="audioDevices.input && audioDevices.input.length > 0">
                                            <select class="form-select" 
                                                    @change="updateInputDeviceFromSelection($event.target.value, $event.target.selectedOptions[0])"
                                                    :disabled="serviceStatus.active">
                                                <option value="">Select input device...</option>
                                                <template x-for="device in audioDevices.input" :key="device.index">
                                                    <option :value="device.name" 
                                                            :data-sample-rate="device.default_sample_rate"
                                                            :data-max-channels="device.max_input_channels"
                                                            :selected="config.input_device_match && config.input_device_match === device.name.split(':')[0].trim()"
                                                            x-text="device.name + (device.is_default ? ' (Default)' : '') + ' - ' + device.max_input_channels + ' channels @ ' + Math.round(device.default_sample_rate/1000) + 'kHz'">
                                                    </option>
                                                </template>
                                            </select>
                                        </template>
                                        <template x-if="!audioDevices.input || audioDevices.input.length === 0">
                                            <div class="text-muted">
                                                <i class="fas fa-exclamation-triangle"></i> No input devices detected
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Technical Settings Row (Expert Mode) -->
                            <div class="row" x-show="expertMode" x-transition>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Device Name <small class="text-muted">(Expert)</small></label>
                                        <input type="text" 
                                                class="form-control" 
                                                x-model="config.input_device_match"
                                                placeholder="trackIT Analog Frontend">
                                        <div class="form-text">Exact device name for matching</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Sample Rate <small class="text-muted">(Expert)</small></label>
                                        <input type="number" 
                                                class="form-control" 
                                                x-model.number="config.sample_rate"
                                                min="1000"
                                                step="1000">
                                        <div class="form-text">Audio sample rate (Hz)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Additional Technical Settings Row (Expert Mode) -->
                            <div class="row" x-show="expertMode" x-transition>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Input Length <small class="text-muted">(Expert)</small></label>
                                        <input type="number" 
                                                class="form-control" 
                                                x-model.number="config.input_length_s"
                                                min="0.1"
                                                max="1.0"
                                                step="0.1">
                                        <div class="form-text">Input buffer length in seconds (0.1-1.0)</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Channels <small class="text-muted">(Expert)</small></label>
                                        <select class="form-select" x-model.number="config.channels">
                                            <option value="1">1 (Mono)</option>
                                            <option value="2">2 (Stereo)</option>
                                        </select>
                                        <div class="form-text">Number of audio channels</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Audio Stream Player - completely removed in server mode -->
                            <template x-if="!serverMode">
                            <div class="row mt-3" 
                                 x-data="{ 
                                     streamAvailable: false, 
                                     checkingStream: true,
                                     streamCheckInterval: null,
                                     pauseTimer: null,
                                     audioConnected: true,
                                     async checkStreamAvailability(force = false) {
                                         // Only skip if service is explicitly inactive and not forcing check
                                         if (!force && serviceStatus && serviceStatus.active === false) {
                                             this.streamAvailable = false;
                                             this.checkingStream = false;
                                             return;
                                         }
                                         this.checkingStream = true;
                                         try {
                                             const response = await fetch('/stream.mp3', {
                                                 method: 'HEAD',
                                                 cache: 'no-cache'
                                             });
                                             this.streamAvailable = response.ok;
                                         } catch (error) {
                                             this.streamAvailable = false;
                                         }
                                         this.checkingStream = false;
                                     },
                                     startStreamChecking() {
                                         this.streamCheckInterval = setInterval(() => {
                                             this.checkStreamAvailability();
                                         }, 5000);
                                     },
                                     stopStreamChecking() {
                                         if (this.streamCheckInterval) {
                                             clearInterval(this.streamCheckInterval);
                                             this.streamCheckInterval = null;
                                         }
                                         this.streamAvailable = false;
                                     },
                                     handleAudioPause() {
                                         // Start 5-second timer to disconnect
                                         this.pauseTimer = setTimeout(() => {
                                             this.disconnectAudio();
                                         }, 5000);
                                     },
                                     handleAudioPlay() {
                                         // Clear disconnect timer and reconnect if needed
                                         if (this.pauseTimer) {
                                             clearTimeout(this.pauseTimer);
                                             this.pauseTimer = null;
                                         }
                                         if (!this.audioConnected) {
                                             // Prevent the current play attempt and reconnect
                                             const audio = this.$refs.audioPlayer;
                                             if (audio) {
                                                 audio.pause(); // Stop current play attempt
                                             }
                                             this.reconnectAudio();
                                         }
                                     },
                                     disconnectAudio() {
                                         const audio = this.$refs.audioPlayer;
                                         if (audio) {
                                             audio.pause();
                                             this.audioConnected = false;
                                         }
                                     },
                                     reconnectAudio() {
                                         const audio = this.$refs.audioPlayer; 
                                         if (audio) {
                                             // Force reload of the stream by updating the src
                                             audio.src = '/stream.mp3?' + Date.now();
                                             audio.load();
                                             this.audioConnected = true;
                                             // Auto-play since user clicked play to reconnect
                                             setTimeout(() => {
                                                 audio.play().catch(() => {
                                                     // Ignore autoplay errors (browser policy)
                                                 });
                                             }, 100);
                                         }
                                     },
                                     cleanup() {
                                         if (this.pauseTimer) {
                                             clearTimeout(this.pauseTimer);
                                             this.pauseTimer = null;
                                         }
                                         this.stopStreamChecking();
                                     }
                                 }"
                                 x-init="checkStreamAvailability(true); startStreamChecking()"
                                 x-destroy="cleanup()">
                                <div class="col-12">
                                    <div class="bg-light rounded-2 p-3 mb-3">
                                        <div class="d-flex align-items-center justify-content-between mb-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-play-circle text-primary me-2"></i>
                                                <label class="form-label mb-0 fw-medium">Live Audio Stream</label>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge d-flex align-items-center gap-1"
                                                      :class="{
                                                          'bg-success': streamAvailable && !checkingStream,
                                                          'bg-warning': checkingStream,
                                                          'bg-secondary': serviceStatus && serviceStatus.active === false,
                                                          'bg-danger': !streamAvailable && !checkingStream && serviceStatus && serviceStatus.active !== false
                                                      }">
                                                    <span class="d-none d-sm-inline" 
                                                          x-text="(serviceStatus && serviceStatus.active === false) ? 'Service Inactive' : (checkingStream ? 'Checking Stream' : (streamAvailable ? 'Stream Active' : 'Stream Unavailable'))">
                                                    </span>
                                                    <span class="d-sm-none" 
                                                          x-text="(serviceStatus && serviceStatus.active === false) ? 'OFF' : (checkingStream ? 'CHECK' : (streamAvailable ? 'LIVE' : 'OFF'))">
                                                    </span>
                                                </span>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm" 
                                                        @click="checkStreamAvailability()"
                                                        :disabled="checkingStream || (serviceStatus && serviceStatus.active === false)"
                                                        title="Refresh stream status">
                                                    <i class="fas fa-sync-alt" :class="{ 'fa-spin': checkingStream }"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="form-text mb-3" 
                                             x-text="(serviceStatus && serviceStatus.active === false) ? 'Stream requires the soundscapepipe service to be running.' : (!audioConnected ? 'Stream disconnected after 5 seconds of inactivity. Click play to reconnect.' : (streamAvailable ? 'Listen to live audio from the configured input device in real-time.' : 'Stream is not available. Please check if the service is configured correctly.'))">
                                        </div>
                                        <audio 
                                            x-ref="audioPlayer"
                                            controls 
                                            preload="none"
                                            class="w-100"
                                            style="height: 40px; border-radius: 0.375rem;"
                                            src="/stream.mp3"
                                            @pause="handleAudioPause()"
                                            @play="handleAudioPlay()"
                                            @ended="handleAudioPause()"
                                            @error="void 0"
                                            :disabled="!streamAvailable || (serviceStatus && serviceStatus.active === false)"
                                            :style="{ opacity: (streamAvailable && !(serviceStatus && serviceStatus.active === false)) ? '1' : '0.5', pointerEvents: (streamAvailable && !(serviceStatus && serviceStatus.active === false)) ? 'auto' : 'none' }">
                                            Your browser does not support the audio element.
                                        </audio>
                                    </div>
                                </div>
                            </div>
                            </template>
                        </div>

                        <!-- BirdEdge Detector Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-dove me-2"></i>
                                    BirdEdge Detector
                                </h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                            type="checkbox" 
                                            x-model="config.detectors.birdedge.enabled" 
                                            id="birdedgeEnabled">
                                    <label class="form-check-label" for="birdedgeEnabled">
                                        Enabled
                                    </label>
                                </div>
                            </div>
                            <div class="form-text mb-3">Full-spectrum analysis of audible frequencies using EfficientNet-B3 image recognition to detect European bird species through classification of 5-second audio spectrograms.</div>
                            
                            <div class="mb-3">
                                <div class="row" x-show="config.detectors.birdedge.enabled"  x-transition>
                                    <div class="col-md-6">
                                        <label class="form-label">Classification Threshold: <span x-text="config.detectors.birdedge.class_threshold.toFixed(2)"></span></label>
                                        <input type="range" 
                                                class="form-range" 
                                                x-model.number="config.detectors.birdedge.class_threshold"
                                                min="0.3"
                                                max="1.0"
                                                step="0.01">
                                        <div class="form-text">Species identification threshold (0.3 - 1.0)</div>
                                        
                                        <div x-show="expertMode" x-transition class="mt-3">
                                            <label class="form-label">Detection Threshold: <span x-text="config.detectors.birdedge.detection_threshold.toFixed(2)"></span></label>
                                            <input type="range" 
                                                    class="form-range" 
                                                    x-model.number="config.detectors.birdedge.detection_threshold"
                                                    min="0.0"
                                                    max="1.0"
                                                    step="0.01">
                                            <div class="form-text">Binary bird call presence/absence threshold (0.0 disables, 0.0 - 1.0)</div>
                                        </div>
                                        
                                        <div x-show="expertMode" x-transition class="mt-3">
                                            <label class="form-label">Channel Strategy <small class="text-muted">(Expert)</small></label>
                                            <select class="form-select" x-model="config.detectors.birdedge.channel_strategy">
                                                <option value="mix">Mix - Combine all channels</option>
                                                <option value="all">All - Analyze channels separately</option>
                                                <option value="or">Or - Detection in any channel triggers detection (logical OR)</option>
                                                <option value="and">And - Detection required in all channels (logical AND)</option>
                                                <template x-if="audioDevices.input && audioDevices.input.find(d => d.name === config.input_device_match || d.name.startsWith(config.input_device_match))">
                                                    <template x-for="channel in Array.from({length: audioDevices.input.find(d => d.name === config.input_device_match || d.name.startsWith(config.input_device_match))?.max_input_channels || 0}, (_, i) => i)" :key="channel">
                                                        <option :value="channel" x-text="`Channel ${channel}`"></option>
                                                    </template>
                                                </template>
                                            </select>
                                            <div class="form-text">Audio channel processing strategy</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">Model Path</label>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="loadModelFiles()"
                                                    :disabled="loadingModels"
                                                    title="Refresh model files">
                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingModels }"></i>
                                            </button>
                                        </div>
                                        <select class="form-select" 
                                                x-model="config.detectors.birdedge.model_path">
                                            <template x-for="modelPath in (modelFiles.birdedge || [])" :key="modelPath">
                                                <option :value="modelPath" x-text="modelPath"></option>
                                            </template>
                                            <!-- Show current value if it's not in the list -->
                                            <template x-if="config.detectors.birdedge.model_path && !(modelFiles.birdedge || []).includes(config.detectors.birdedge.model_path)">
                                                <option :value="config.detectors.birdedge.model_path" 
                                                        x-text="config.detectors.birdedge.model_path + ' (custom)'"></option>
                                            </template>
                                        </select>
                                        <div class="form-text">Path to the BirdEdge model file (.onnx) - Default: MarBird_EFL0_GER.onnx</div>
                                    </div>
                                </div>
                                
                                <!-- BirdEdge Detection Tasks -->
                                <div x-show="config.detectors.birdedge.enabled" x-transition class="mt-3">
                                    <div class="mb-3">
                                        <label class="form-label mb-2">Detection Tasks</label>
                                        <div class="form-text mb-3">Define time spans when BirdEdge detector should be active. Leave empty for continuous operation.</div>
                                        
                                        <template x-for="(task, index) in config.detectors.birdedge.tasks" :key="index">
                                                <div class="bg-light rounded-2 p-3 mb-2">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <div class="d-flex align-items-center flex-grow-1 me-3">
                                                            <i class="fas fa-clock text-primary me-2"></i>
                                                            <input type="text" 
                                                                   class="form-control form-control-sm fw-medium" 
                                                                   x-model="task.name" 
                                                                   placeholder="Enter task name, e.g., dawn chorus, morning song, evening calls..." 
                                                                   required>
                                                        </div>
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm" 
                                                                @click="removeDetectorTask('birdedge', index)"
                                                                title="Remove task">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-success fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-play me-1"></i><span class="d-none d-md-inline">Start</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.startReference"
                                                                                @change="updateDetectorTaskTimeString('birdedge', task, 'start')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.startSign"
                                                                                @change="updateDetectorTaskTimeString('birdedge', task, 'start')"
                                                                                :disabled="task.startReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.startOffset"
                                                                               @change="updateDetectorTaskTimeString('birdedge', task, 'start')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-danger fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-stop me-1"></i><span class="d-none d-md-inline">Stop</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.stopReference"
                                                                                @change="updateDetectorTaskTimeString('birdedge', task, 'stop')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.stopSign"
                                                                                @change="updateDetectorTaskTimeString('birdedge', task, 'stop')"
                                                                                :disabled="task.stopReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.stopOffset"
                                                                               @change="updateDetectorTaskTimeString('birdedge', task, 'stop')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                        
                                        <div class="mt-3">
                                            <button type="button" 
                                                    class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                    @click="addDetectorTask('birdedge')">
                                                <i class="fas fa-plus me-2"></i>
                                                Add Task Entry
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- YoloBat Detector Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-moon me-2"></i>
                                    YoloBat Detector
                                </h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           x-model="config.detectors.yolobat.enabled" 
                                           id="yolobatEnabled">
                                    <label class="form-check-label" for="yolobatEnabled">
                                        Enabled
                                    </label>
                                </div>
                            </div>
                            <div class="form-text mb-3">Performs full spectrum analysis using the YOLO object detection framework to detect bat calls.</div>
                            
                            <div class="mb-3">
                                <div class="row" x-show="config.detectors.yolobat.enabled"  x-transition>
                                    <div class="col-md-6">
                                        <label class="form-label">Classification Threshold: <span x-text="config.detectors.yolobat.class_threshold.toFixed(2)"></span></label>
                                        <input type="range" 
                                               class="form-range" 
                                               x-model.number="config.detectors.yolobat.class_threshold"
                                               min="0.3"
                                               max="1.0"
                                               step="0.01">
                                        <div class="form-text">Species identification threshold (0.3 - 1.0)</div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">Model Path</label>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="loadModelFiles()"
                                                    :disabled="loadingModels"
                                                    title="Refresh model files">
                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingModels }"></i>
                                            </button>
                                        </div>
                                        <select class="form-select" 
                                                x-model="config.detectors.yolobat.model_path"
                                                @change="loadYoloBatLabels()">
                                            <template x-for="modelPath in (modelFiles.yolobat || [])" :key="modelPath">
                                                <option :value="modelPath" x-text="modelPath"></option>
                                            </template>
                                            <!-- Show current value if it's not in the list -->
                                            <template x-if="config.detectors.yolobat.model_path && !(modelFiles.yolobat || []).includes(config.detectors.yolobat.model_path)">
                                                <option :value="config.detectors.yolobat.model_path" 
                                                        x-text="config.detectors.yolobat.model_path + ' (custom)'"></option>
                                            </template>
                                        </select>
                                        <div class="form-text">Path to the YOLO model file (.xml) - Default: yolobat11_2025.3.2</div>
                                    </div>
                                </div>
                                
                                <!-- YoloBat Channel Strategy (Expert Mode) -->
                                <div class="row" x-show="config.detectors.yolobat.enabled && expertMode" x-transition>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Channel Strategy <small class="text-muted">(Expert)</small></label>
                                                                                                                                                                                    <select class="form-select" x-model="config.detectors.yolobat.channel_strategy">
                                                 <option value="mix">Mix - Combine all channels</option>
                                                 <option value="all">All - Analyze channels separately</option>
                                                <template x-if="audioDevices.input && audioDevices.input.find(d => d.name === config.input_device_match || d.name.startsWith(config.input_device_match))">
                                                    <template x-for="channel in Array.from({length: audioDevices.input.find(d => d.name === config.input_device_match || d.name.startsWith(config.input_device_match))?.max_input_channels || 0}, (_, i) => i)" :key="channel">
                                                        <option :value="channel" x-text="`Channel ${channel}`"></option>
                                                    </template>
                                                </template>
                                            </select>
                                            <div class="form-text">Audio channel processing strategy</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- YoloBat Detection Tasks -->
                                <div x-show="config.detectors.yolobat.enabled" x-transition class="mt-3">
                                    <div class="mb-3">
                                        <label class="form-label mb-2">Detection Tasks</label>
                                        <div class="form-text mb-3">Define time spans when YoloBat detector should be active. Leave empty for continuous operation.</div>
                                        

                                        <template x-for="(task, index) in config.detectors.yolobat.tasks" :key="index">
                                                <div class="bg-light rounded-2 p-3 mb-2">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <div class="d-flex align-items-center flex-grow-1 me-3">
                                                            <i class="fas fa-clock text-primary me-2"></i>
                                                            <input type="text" 
                                                                   class="form-control form-control-sm fw-medium" 
                                                                   x-model="task.name" 
                                                                   placeholder="Enter task name, e.g., foraging, evening emergence, night hunting..." 
                                                                   required>
                                                        </div>
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm" 
                                                                @click="removeDetectorTask('yolobat', index)"
                                                                title="Remove task">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-success fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-play me-1"></i><span class="d-none d-md-inline">Start</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.startReference"
                                                                                @change="updateDetectorTaskTimeString('yolobat', task, 'start')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.startSign"
                                                                                @change="updateDetectorTaskTimeString('yolobat', task, 'start')"
                                                                                :disabled="task.startReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.startOffset"
                                                                               @change="updateDetectorTaskTimeString('yolobat', task, 'start')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-danger fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-stop me-1"></i><span class="d-none d-md-inline">Stop</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.stopReference"
                                                                                @change="updateDetectorTaskTimeString('yolobat', task, 'stop')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.stopSign"
                                                                                @change="updateDetectorTaskTimeString('yolobat', task, 'stop')"
                                                                                :disabled="task.stopReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.stopOffset"
                                                                               @change="updateDetectorTaskTimeString('yolobat', task, 'stop')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        </template>
                                        
                                        <div class="mt-3">
                                            <button type="button" 
                                                    class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                    @click="addDetectorTask('yolobat')">
                                                <i class="fas fa-plus me-2"></i>
                                                Add Task Entry
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Time-based Continuous Recording -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-clock me-2"></i>
                                    Time-based Continuous Recording
                                </h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           x-model="config.detectors.schedule.enabled" 
                                           id="scheduleEnabled">
                                    <label class="form-check-label" for="scheduleEnabled">
                                        Enabled
                                    </label>
                                </div>
                            </div>
                            <div class="form-text mb-3">Enable continuous audio recording during specified time periods without using any detection model. Useful for scheduled continuous audio capture and monitoring.</div>
                            <div class="mb-3">

                                <!-- Time-based Recording Tasks -->
                                <div x-show="config.detectors.schedule.enabled" x-transition class="mt-3">
                                    <div class="mb-3">
                                        <label class="form-label mb-2">Recording Tasks</label>
                                        

                                        <template x-for="(task, index) in config.detectors.schedule.tasks" :key="index">
                                                <div class="bg-light rounded-2 p-3 mb-2">
                                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                                        <div class="d-flex align-items-center flex-grow-1 me-3">
                                                            <i class="fas fa-clock text-primary me-2"></i>
                                                            <input type="text" 
                                                                   class="form-control form-control-sm fw-medium" 
                                                                   x-model="task.name" 
                                                                   placeholder="Enter task name, e.g., continuous monitoring, overnight recording, daily survey..." 
                                                                   required>
                                                        </div>
                                                        <button type="button" 
                                                                class="btn btn-outline-danger btn-sm" 
                                                                @click="removeDetectorTask('schedule', index)"
                                                                title="Remove task">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                    <div class="row g-3">
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-success fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-play me-1"></i><span class="d-none d-md-inline">Start</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.startReference"
                                                                                @change="updateDetectorTaskTimeString('schedule', task, 'start')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.startSign"
                                                                                @change="updateDetectorTaskTimeString('schedule', task, 'start')"
                                                                                :disabled="task.startReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.startOffset"
                                                                               @change="updateDetectorTaskTimeString('schedule', task, 'start')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <label class="text-danger fw-semibold small mb-0 schedule-label">
                                                                    <i class="fas fa-stop me-1"></i><span class="d-none d-md-inline">Stop</span>
                                                                </label>
                                                                <div class="row g-1 flex-grow-1">
                                                                    <div class="col">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="task.stopReference"
                                                                                @change="updateDetectorTaskTimeString('schedule', task, 'stop')">
                                                                            <option value="time">Clock Time</option>
                                                                            <option value="sunrise">Sunrise</option>
                                                                            <option value="sunset">Sunset</option>
                                                                            <option value="dawn">Dawn</option>
                                                                            <option value="dusk">Dusk</option>
                                                                            <option value="noon">Solar Noon</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <select class="form-select form-select-sm" 
                                                                                style="width: 70px;"
                                                                                x-model="task.stopSign"
                                                                                @change="updateDetectorTaskTimeString('schedule', task, 'stop')"
                                                                                :disabled="task.stopReference === 'time'">
                                                                            <option value="+">+</option>
                                                                            <option value="-">-</option>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-auto">
                                                                        <input type="time" 
                                                                               class="form-control form-control-sm" 
                                                                               style="width: 110px;"
                                                                               x-model="task.stopOffset"
                                                                               @change="updateDetectorTaskTimeString('schedule', task, 'stop')">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                        </template>
                                        
                                        <div class="mt-3">
                                            <button type="button" 
                                                    class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                    @click="addDetectorTask('schedule')">
                                                <i class="fas fa-plus me-2"></i>
                                                Add Task Entry
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recording Section -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-record-vinyl me-2"></i>
                                Recording Settings
                            </h6>
                            <div class="bg-light rounded-2 p-3">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-cog text-primary me-2"></i>
                                    <label class="form-label mb-0 fw-medium">Default Recording Settings</label>
                                </div>
                                <div class="form-text mb-3">These settings apply to all species that are not explicitly handled in a recording group defined below. Species-specific groups can override these default values.</div>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   x-model="config.maximize_confidence" 
                                                   id="maximize_confidence">
                                            <label class="form-check-label small" for="maximize_confidence">
                                                Maximize Confidence
                                            </label>
                                        </div>
                                        <div class="form-text small">Record highest confidence detections per day</div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Default Ratio: <span x-text="config.ratio.toFixed(2)"></span></label>
                                        <input type="range" 
                                               class="form-range" 
                                               x-model.number="config.ratio"
                                               min="0.0"
                                               max="1.0"
                                               step="0.01"
                                               :disabled="config.maximize_confidence">
                                        <div class="form-text small" :class="{ 'text-muted': config.maximize_confidence }">
                                            <span x-show="!config.maximize_confidence">Ratio of calls to record (0.0-1.0)</span>
                                            <span x-show="config.maximize_confidence">Disabled when maximize confidence is enabled</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Post-Detection Duration: <span x-text="config.length_s"></span> seconds</label>
                                        <input type="range" 
                                               class="form-range" 
                                               x-model.number="config.length_s"
                                               min="1"
                                               max="60"
                                               step="1">
                                        <div class="form-text small">Seconds to record after detection</div>
                                    </div>
                                </div>
                            </div>



                            <!-- Recording Groups Section -->
                            <div class="mt-4">
                                <div class="mb-3">
                                    <label class="form-label mb-2">Recording Groups</label>
                                    <div class="form-text mb-3">Define recording groups with custom recording ratios and confidence settings. Groups allow you to prioritize certain species for recording.</div>
                                    <template x-for="(group, groupName) in config.groups" :key="groupName">
                                        <div class="bg-light rounded-2 p-3 mb-3">
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <div class="d-flex align-items-center flex-grow-1 me-3">
                                                    <i class="fas fa-layer-group text-primary me-2"></i>
                                                    <input type="text" 
                                                           class="form-control form-control-sm fw-medium" 
                                                           :value="groupName"
                                                           @blur="renameGroup(groupName, $event.target.value)"
                                                           @keydown.enter="$event.target.blur()"
                                                           placeholder="Enter group name, e.g., red list species, common bats, morning chorus..." 
                                                           required>
                                                </div>
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm" 
                                                        @click="removeGroup(groupName)"
                                                        title="Remove group">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Group Settings -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <div class="form-check form-switch mb-2">
                                                        <input class="form-check-input" 
                                                               type="checkbox" 
                                                               x-model="group.maximize_confidence" 
                                                               :id="'group-maximize-' + groupName">
                                                        <label class="form-check-label small" :for="'group-maximize-' + groupName">
                                                            Maximize Confidence
                                                        </label>
                                                    </div>
                                                    <div class="form-text small">Record highest confidence detections per day</div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small">Recording Ratio: <span x-text="(group.ratio || 0).toFixed(2)"></span></label>
                                                    <input type="range" 
                                                           class="form-range" 
                                                           x-model.number="group.ratio"
                                                           min="0.0"
                                                           max="1.0"
                                                           step="0.01"
                                                           :disabled="group.maximize_confidence"
                                                           x-effect="$el.disabled = group.maximize_confidence">
                                                    <div class="form-text small" :class="{ 'text-muted': group.maximize_confidence }">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <label class="form-label small">Post-Detection Duration: <span x-text="group.length_s || config.length_s || 5"></span> seconds</label>
                                                    <input type="range" 
                                                           class="form-range" 
                                                           x-model.number="group.length_s"
                                                           min="1"
                                                           max="60"
                                                           step="1">
                                                </div>
                                            </div>
                                            
                                            <!-- Species List -->
                                            <div class="mb-3">
                                                <label class="form-label small mb-2">Species in Group</label>
                                                <div class="form-text small mb-2">
                                                    Enter the exact classifier label or select from suggestions. 
                                                    BirdEdge uses scientific names (e.g., "Tyto alba"), YoloBat uses abbreviations (e.g., "Ppip"). 
                                                    Start typing to see available options with translations. Only species for enabled detectors are shown.
                                                    <template x-if="loadingSpecies">
                                                        <span class="text-muted"><i class="fas fa-spinner fa-spin ms-1"></i> Loading species...</span>
                                                    </template>
                                                </div>
                                                
                                                                                                <template x-for="(species, speciesIndex) in group.species" :key="speciesIndex">
                                                    <div class="mb-2" x-data="{ 
                                                        showDropdown: false, 
                                                        selectedIndex: -1,
                                                        filteredSpecies: [],
                                                        filterSpecies(query) {
                                                            const allSpecies = [];
                                                            if (config.detectors.birdedge?.enabled && speciesData.birdedge) {
                                                                speciesData.birdedge.forEach(s => {
                                                                    allSpecies.push({
                                                                        value: s.scientific,
                                                                        display: getConsistentSpeciesDisplayText(s, 'BirdEdge'),
                                                                        type: 'birdedge'
                                                                    });
                                                                });
                                                            }
                                                            if (config.detectors.yolobat?.enabled && speciesData.yolobat) {
                                                                speciesData.yolobat.forEach(s => {
                                                                    allSpecies.push({
                                                                        value: s.modelLabel,
                                                                        display: getConsistentSpeciesDisplayText(s, 'YoloBat'),
                                                                        type: 'yolobat'
                                                                    });
                                                                });
                                                            }
                                                            
                                                            if (!query || query.length < 1) {
                                                                // Show all species when no query is provided
                                                                this.filteredSpecies = allSpecies;
                                                                this.selectedIndex = this.filteredSpecies.length > 0 ? 0 : -1;
                                                                return;
                                                            }
                                                            
                                                            this.filteredSpecies = allSpecies.filter(s => 
                                                                s.value.toLowerCase().includes(query.toLowerCase()) ||
                                                                s.display.toLowerCase().includes(query.toLowerCase())
                                                            );
                                                            this.selectedIndex = this.filteredSpecies.length > 0 ? 0 : -1;
                                                        },
                                                        selectSpecies(species) {
                                                            group.species[speciesIndex] = species.value;
                                                            this.showDropdown = false;
                                                            this.selectedIndex = -1;
                                                            updateSpeciesInput({ target: { value: species.value } }, groupName, speciesIndex);
                                                        },
                                                        handleKeydown(event) {
                                                            if (!this.showDropdown || this.filteredSpecies.length === 0) return;
                                                            
                                                            switch(event.key) {
                                                                case 'ArrowDown':
                                                                    event.preventDefault();
                                                                    this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredSpecies.length - 1);
                                                                    break;
                                                                case 'ArrowUp':
                                                                    event.preventDefault();
                                                                    this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                                                                    break;
                                                                case 'Enter':
                                                                    event.preventDefault();
                                                                    if (this.selectedIndex >= 0 && this.selectedIndex < this.filteredSpecies.length) {
                                                                        this.selectSpecies(this.filteredSpecies[this.selectedIndex]);
                                                                    }
                                                                    break;
                                                                case 'Escape':
                                                                    this.showDropdown = false;
                                                                    this.selectedIndex = -1;
                                                                    break;
                                                            }
                                                        }
                                                    }">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="flex-grow-1 position-relative">
                                                                <input type="text" 
                                                                       class="form-control form-control-sm" 
                                                                       x-model="group.species[speciesIndex]"
                                                                       @input="filterSpecies($event.target.value); updateSpeciesInput($event, groupName, speciesIndex)"
                                                                       @focus="filterSpecies($event.target.value); showDropdown = true"
                                                                       @blur="setTimeout(() => { showDropdown = false; selectedIndex = -1; }, 150)"
                                                                       @keydown="handleKeydown($event)"
                                                                       placeholder="Enter classifier label (e.g., Tyto alba, Ppip)"
                                                                       spellcheck="false"
                                                                       autocomplete="off">
                                                                
                                                                <!-- Custom dropdown -->
                                                                <div x-show="showDropdown && filteredSpecies.length > 0" 
                                                                     x-transition:enter="transition ease-out duration-100"
                                                                     x-transition:enter-start="opacity-0 scale-95"
                                                                     x-transition:enter-end="opacity-100 scale-100"
                                                                     x-transition:leave="transition ease-in duration-75"
                                                                     x-transition:leave-start="opacity-100 scale-100"
                                                                     x-transition:leave-end="opacity-0 scale-95"
                                                                     class="position-absolute top-100 start-0 w-100 bg-white border border-secondary rounded shadow-sm mt-1 z-3"
                                                                     style="max-height: 200px; overflow-y: auto;">
                                                                    <template x-for="(species, idx) in filteredSpecies" :key="species.value">
                                                                        <div class="px-3 py-2 cursor-pointer border-bottom border-light small"
                                                                             :class="{ 'bg-primary text-white': idx === selectedIndex, 'hover:bg-light': idx !== selectedIndex }"
                                                                             @click="selectSpecies(species)"
                                                                             @mouseenter="selectedIndex = idx"
                                                                             x-text="species.display">
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                            <button type="button" 
                                                                    class="btn btn-outline-secondary btn-sm" 
                                                                    @click="loadSpeciesData()"
                                                                    :disabled="loadingSpecies"
                                                                    title="Refresh species list">
                                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingSpecies }"></i>
                                                            </button>
                                                            <button type="button" 
                                                                    class="btn btn-outline-danger btn-sm" 
                                                                    @click="removeSpeciesFromGroup(groupName, speciesIndex)"
                                                                    title="Remove species"
                                                                    :disabled="group.species.length <= 1">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </template>
                                                
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm" 
                                                        @click="addSpeciesToGroup(groupName)">
                                                    <i class="fas fa-plus me-1"></i>
                                                    Add Species
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <template x-if="!config.groups || Object.keys(config.groups).length === 0">
                                        <div class="text-muted text-center py-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            No recording groups configured. Create groups to apply custom recording settings to specific species.
                                        </div>
                                    </template>
                                    
                                    <div class="mt-3">
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                @click="addGroup()">
                                            <i class="fas fa-plus me-2"></i>
                                            Add Recording Group
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Soundfile Settings Section -->
                        <div class="mb-4">
                            <div class="bg-light rounded-2 p-3">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="fas fa-file-audio text-primary me-2"></i>
                                    <label class="form-label mb-0 fw-medium">Soundfile Settings</label>
                                </div>
                                <div class="form-text mb-3">Configure the format and duration limits for recorded audio files.</div>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label small">Soundfile Format</label>
                                        <select class="form-select form-select-sm" x-model="config.soundfile_format">
                                            <option value="flac">FLAC (lossless compression)</option>
                                            <option value="wav">WAV (uncompressed)</option>
                                        </select>
                                        <div class="form-text small">Audio file format for recordings</div>
                                    </div>
                                    <div class="col-md-8">
                                        <label class="form-label small">Maximum Duration: <span x-text="config.soundfile_limit"></span> seconds</label>
                                        <input type="range" 
                                               class="form-range" 
                                               x-model.number="config.soundfile_limit"
                                               min="1"
                                               max="300"
                                               step="1">
                                        <div class="form-text small">Maximum length per soundfile - longer recordings will be chunked (bats: ~2s, birds: ~30s, both: ~5s)</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Output Device Settings (Expert Mode) -->
                        <div class="mb-4" x-show="expertMode" x-transition>
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-volume-up me-2"></i>
                                Output Device
                                <small class="text-muted ms-2">(Expert Mode)</small>
                            </h6>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <label class="form-label mb-0">Output Device</label>
                                                <small class="text-muted" x-show="serviceStatus.active">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    Stop soundscapepipe service to refresh audio device lists
                                                </small>
                                            </div>
                                            <button type="button" 
                                                    class="btn btn-sm btn-outline-secondary"
                                                    @click="loadAudioDevices()"
                                                    :disabled="loadingDevices || serviceStatus.active"
                                                    title="Refresh audio devices">
                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingDevices }"></i>
                                            </button>
                                        </div>
                                        <template x-if="audioDevices.output && audioDevices.output.length > 0">
                                            <select class="form-select" 
                                                    @change="updateOutputDeviceFromSelection($event.target.value, $event.target.selectedOptions[0])"
                                                    :disabled="serviceStatus.active">
                                                <option value="">Select output device...</option>
                                                <template x-for="device in audioDevices.output" :key="device.index">
                                                    <option :value="device.name" 
                                                            :data-sample-rate="device.default_sample_rate"
                                                        :data-max-channels="device.max_output_channels"
                                                            :selected="config.output_device_match && config.output_device_match === device.name.split(':')[0].trim()"
                                                            x-text="device.name + (device.is_default ? ' (Default)' : '') + ' - ' + device.max_output_channels + ' channels @ ' + Math.round(device.default_sample_rate/1000) + 'kHz'">
                                                    </option>
                                                </template>
                                            </select>
                                        </template>
                                        <template x-if="!audioDevices.output || audioDevices.output.length === 0">
                                            <div class="text-muted">
                                                <i class="fas fa-exclamation-triangle"></i> No output devices detected
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Expert Mode Output Settings -->
                            <div class="row" x-show="expertMode" x-transition>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Device Match <small class="text-muted">(Expert)</small></label>
                                        <input type="text" 
                                               class="form-control" 
                                               x-model="config.output_device_match"
                                               placeholder="bcm2835 Headphones">
                                        <div class="form-text">Device identifier pattern</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Speaker Enable Pin <small class="text-muted">(Expert)</small></label>
                                        <input type="number" 
                                               class="form-control" 
                                               x-model.number="config.speaker_enable_pin"
                                               min="0">
                                        <div class="form-text">GPIO pin number</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Highpass Frequency <small class="text-muted">(Expert)</small></label>
                                        <input type="number" 
                                               class="form-control" 
                                               x-model.number="config.highpass_freq"
                                               min="0"
                                               step="10">
                                        <div class="form-text">Hz (0 disables filter)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Lure Tasks -->
                            <div class="mt-4">
                                <div class="mb-3">
                                    <label class="form-label mb-2">Lure Tasks</label>
                                    <div class="form-text mb-3">Configure automated playback of lure calls to attract target species for detection and recording.</div>
                                    
                                    <template x-for="(task, index) in config.lure.tasks" :key="index">
                                        <div class="bg-light rounded-2 p-3 mb-2">
                                            <div class="d-flex align-items-center justify-content-between mb-3">
                                                <div class="d-flex align-items-center flex-grow-1 me-3">
                                                    <i class="fas fa-volume-up text-primary me-2"></i>
                                                    <input type="text" 
                                                           class="form-control form-control-sm fw-medium" 
                                                           x-model="task.species" 
                                                           placeholder="Enter species name..." 
                                                           required>
                                                </div>
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm" 
                                                        @click="removeLureTask(index)"
                                                        title="Remove task">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Time Settings -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <label class="text-success fw-semibold small mb-0 schedule-label">
                                                            <i class="fas fa-play me-1"></i><span class="d-none d-md-inline">Start</span>
                                                        </label>
                                                        <div class="row g-1 flex-grow-1">
                                                            <div class="col">
                                                                <select class="form-select form-select-sm" 
                                                                        x-model="task.startReference"
                                                                        @change="updateLureTaskTimeString(task, 'start')">
                                                                    <option value="time">Clock Time</option>
                                                                    <option value="sunrise">Sunrise</option>
                                                                    <option value="sunset">Sunset</option>
                                                                    <option value="dawn">Dawn</option>
                                                                    <option value="dusk">Dusk</option>
                                                                    <option value="noon">Solar Noon</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <select class="form-select form-select-sm" 
                                                                        style="width: 70px;"
                                                                        x-model="task.startSign"
                                                                        @change="updateLureTaskTimeString(task, 'start')"
                                                                        :disabled="task.startReference === 'time'">
                                                                    <option value="+">+</option>
                                                                    <option value="-">-</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <input type="time" 
                                                                       class="form-control form-control-sm" 
                                                                       style="width: 110px;"
                                                                       x-model="task.startOffset"
                                                                       @change="updateLureTaskTimeString(task, 'start')">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <label class="text-danger fw-semibold small mb-0 schedule-label">
                                                            <i class="fas fa-stop me-1"></i><span class="d-none d-md-inline">Stop</span>
                                                        </label>
                                                        <div class="row g-1 flex-grow-1">
                                                            <div class="col">
                                                                <select class="form-select form-select-sm" 
                                                                        x-model="task.stopReference"
                                                                        @change="updateLureTaskTimeString(task, 'stop')">
                                                                    <option value="time">Clock Time</option>
                                                                    <option value="sunrise">Sunrise</option>
                                                                    <option value="sunset">Sunset</option>
                                                                    <option value="dawn">Dawn</option>
                                                                    <option value="dusk">Dusk</option>
                                                                    <option value="noon">Solar Noon</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <select class="form-select form-select-sm" 
                                                                        style="width: 70px;"
                                                                        x-model="task.stopSign"
                                                                        @change="updateLureTaskTimeString(task, 'stop')"
                                                                        :disabled="task.stopReference === 'time'">
                                                                    <option value="+">+</option>
                                                                    <option value="-">-</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-auto">
                                                                <input type="time" 
                                                                       class="form-control form-control-sm" 
                                                                       style="width: 110px;"
                                                                       x-model="task.stopOffset"
                                                                       @change="updateLureTaskTimeString(task, 'stop')">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Audio Paths -->
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="form-label small mb-0">Audio File Paths</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" 
                                                               type="checkbox" 
                                                               x-model="task.record"
                                                               :id="'record-' + index">
                                                        <label class="form-check-label small" :for="'record-' + index">
                                                            Record Playback
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="form-text mb-2">Specify filesystem paths to audio files for playback</div>
                                                <template x-for="(path, pathIndex) in task.paths" :key="pathIndex">
                                                    <div class="mb-2">
                                                        <div class="d-flex align-items-start gap-2">
                                                            <div class="flex-grow-1">
                                                                <select class="form-select form-select-sm" 
                                                                        x-model="task.paths[pathIndex]">
                                                                    <option value="">Select audio path...</option>
                                                                    <optgroup label="Directories" x-show="lureFiles.directories && lureFiles.directories.length > 0">
                                                                        <template x-for="dir in lureFiles.directories" :key="dir">
                                                                            <option :value="dir" x-text="dir"></option>
                                                                        </template>
                                                                    </optgroup>
                                                                    <optgroup label="Audio Files" x-show="lureFiles.files && lureFiles.files.length > 0">
                                                                        <template x-for="file in lureFiles.files" :key="file">
                                                                            <option :value="file" x-text="file"></option>
                                                                        </template>
                                                                    </optgroup>
                                                                </select>
                                                            </div>
                                                            <button type="button" 
                                                                    class="btn btn-outline-secondary btn-sm" 
                                                                    @click="loadLureFiles()"
                                                                    title="Refresh lure files"
                                                                    :disabled="loadingLureFiles">
                                                                <i class="fas fa-sync-alt" :class="{ 'fa-spin': loadingLureFiles }"></i>
                                                            </button>
                                                            <button type="button" 
                                                                    class="btn btn-outline-danger btn-sm" 
                                                                    @click="removeLureTaskPath(index, pathIndex)"
                                                                    title="Remove path"
                                                                    :disabled="task.paths.length <= 1">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        <template x-if="loadingLureFiles">
                                                            <div class="text-muted small mt-1">
                                                                <i class="fas fa-spinner fa-spin me-1"></i>
                                                                Loading lure files...
                                                            </div>
                                                        </template>
                                                        <template x-if="!loadingLureFiles && (!lureFiles.directories || lureFiles.directories.length === 0) && (!lureFiles.files || lureFiles.files.length === 0)">
                                                            <div class="text-muted small mt-1">
                                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                                No files found in lure directories (/data/lure or /home/pi/lure)
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <button type="button" 
                                                        class="btn btn-outline-secondary btn-sm" 
                                                        @click="addLureTaskPath(index)">
                                                    <i class="fas fa-plus me-1"></i>
                                                    Add Path
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <template x-if="!config.lure.tasks || config.lure.tasks.length === 0">
                                        <div class="text-muted text-center py-2">
                                            <i class="fas fa-info-circle me-1"></i>
                                            No lure tasks configured. Advanced feature for automated call playback.
                                        </div>
                                    </template>
                                    
                                    <div class="mt-3">
                                        <button type="button" 
                                                class="btn btn-outline-primary btn-sm add-schedule-btn" 
                                                @click="addLureTask()">
                                            <i class="fas fa-plus me-2"></i>
                                            Add Lure Task
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Optional Arguments Section (Expert Mode) -->
                        <div class="mb-4" x-show="expertMode" x-transition>
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-cogs me-2"></i>
                                Optional Arguments
                                <small class="text-muted ms-2">(Expert Mode)</small>
                            </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Stream Port</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   x-model.number="config.stream_port"
                                                   min="1"
                                                   max="65535"
                                                   required>
                                            <div class="form-text">HTTP audio stream port for real-time audio streaming</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">
                                                Disk Reserve: <span x-text="config.disk_reserve_mb"></span> MB
                                                <span x-show="!diskInfo || diskInfo.length === 0" class="text-muted small"> (loading disk size...)</span>
                                                <span x-show="diskInfo && diskInfo.length > 0" class="text-muted small"> 
                                                    (max: <span x-text="Math.round(getDataDiskSize() / 1024)"></span> GB)
                                                </span>
                                            </label>
                                            <input type="range" 
                                                   class="form-range" 
                                                   x-model.number="config.disk_reserve_mb"
                                                   min="512"
                                                   :max="(diskInfo && diskInfo.length > 0) ? getDataDiskSize() : 2048"
                                                   step="1"
                                                   :key="`disk-range-${(diskInfo && diskInfo.length > 0) ? getDataDiskSize() : 2048}`">
                                            <div class="form-text">Minimum free space to preserve for detections and logging</div>
                                        </div>
                                    </div>
                                </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between gap-2">
                            <div class="d-flex gap-2">
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @click="resetConfig()"
                                        :disabled="!configLoaded">
                                    Reset
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" 
                                        class="btn"
                                        :class="{
                                            'btn-success': saveState === 'idle',
                                            'btn-primary': saveState === 'saving',
                                            'btn-outline-success': saveState === 'saved'
                                        }"
                                        :disabled="!configLoaded || saveState === 'saving'">
                                    <template x-if="saveState === 'idle'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-save me-1"></i>
                                            Save
                                        </div>
                                    </template>
                                    <template x-if="saveState === 'saving'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                            Saving...
                                        </div>
                                    </template>
                                    <template x-if="saveState === 'saved'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check me-1"></i>
                                            Saved!
                                        </div>
                                    </template>
                                </button>
                                <button type="button" 
                                        class="btn"
                                        :class="{
                                            'btn-warning': saveRestartState === 'idle',
                                            'btn-primary': saveRestartState === 'saving' || saveRestartState === 'restarting',
                                            'btn-outline-success': saveRestartState === 'saved'
                                        }"
                                        @click="saveAndRestartService()"
                                        :disabled="!configLoaded || serviceStatus.status === 'not-found' || saveRestartState === 'saving' || saveRestartState === 'restarting'"
                                        x-show="!serverMode">
                                    <template x-if="saveRestartState === 'idle'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-save me-1"></i>
                                            <i class="fas fa-redo me-1"></i>
                                            Save & Restart
                                        </div>
                                    </template>
                                    <template x-if="saveRestartState === 'saving'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                            Saving...
                                        </div>
                                    </template>
                                    <template x-if="saveRestartState === 'restarting'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                            Restarting...
                                        </div>
                                    </template>
                                    <template x-if="saveRestartState === 'saved'">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-check me-1"></i>
                                            Saved & Restarted!
                                        </div>
                                    </template>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>